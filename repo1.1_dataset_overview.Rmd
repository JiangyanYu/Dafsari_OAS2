---
title: "WHuang PBMC project"
author: "Jiangyan Yu (jiangyan.yu.de@gmail.com)"
date: "`r Sys.Date()`"
output:
  html_document: 
    code_folding: hide
    number_sections: yes
    theme: united
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---
in current analysis, no batch correction was performed.

# general steps

```{r global_options}
knitr::opts_chunk$set(warning=FALSE, messgae=FALSE, fig.path='Figs/', results = "hide")
## fig.width=4, fig.height=4
```

## load library

```{r include=FALSE}
rm(list=ls())
gc()
#CRAN packages
list.of.packages <- c("readr",
                      "cowplot",
                      "useful",
                      "stringr",
                      "umap",
                      "ggplot2",
                      "reshape2",
                      "dplyr",
                      "tidyr",
                      "Matrix.utils",
                      "VGAM",
                      "plotly",
                      "future",
                      "data.table"
)

# new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
# if(length(new.packages)>0) 
#   install.packages(new.packages)

#BioconductoR packages
list.of.bioc.packages <- c("tximport",
                           "DESeq2",
                           "Seurat",
                           "slingshot",
                           "flowCore",
                           "biomaRt",
                           "clusterProfiler",
                           "org.Hs.eg.db",
                           "org.Mm.eg.db",
                           "GSEABase",
                           "DOSE",
                           "BiocGenerics",
                           "DelayedArray",
                           "DelayedMatrixStats",
                           "limma",
                           "S4Vectors",
                           "SingleCellExperiment",
                           "SummarizedExperiment",
                           "batchelor",
                           "ComplexHeatmap")
                           # "annotables")
new.packages.bioc <- list.of.bioc.packages[!(list.of.bioc.packages %in% installed.packages()[,"Package"])]
# 
if(length(new.packages.bioc)>0)if (!requireNamespace("BiocManager")) install.packages("BiocManager")
BiocManager::install(new.packages.bioc, update = FALSE)

lapply(c(list.of.packages,list.of.bioc.packages), require, character.only = TRUE)

rm(list.of.bioc.packages,list.of.packages,new.packages,new.packages.bioc)
```

## working directory

```{r}
## Mac directory
working.dir = "/home/jyu/rstudio/"
working.dir = "/Users/jiangyanyu/sciebo/Projects2023/Dafsari_PUF60_ownerJYu/"
global_ref_dir = paste0(working.dir,"/analysis_jyu/Scripts/")
gsea_pathway_dir = paste0(working.dir,"/analysis_jyu/Scripts/")
# source(paste0(global_ref_dir,"general_functions.R"))
# 
allcolour=c("#DC143C","#0000FF","#20B2AA","#FFA500","#9370DB","#98FB98","#F08080","#1E90FF","#7CFC00","#FFFF00",
              "#808000","#FF00FF","#FA8072","#7B68EE","#9400D3","#800080","#A0522D","#D2B48C","#D2691E","#87CEEB","#40E0D0","#5F9EA0",
              "#FF1493","#0000CD","#008B8B","#FFE4B5","#8A2BE2","#228B22","#E9967A","#4682B4","#32CD32","#F0E68C","#FFFFE0","#EE82EE",
              "#FF6347","#6A5ACD","#9932CC","#8B008B","#8B4513","#DEB887")
```


# load save object

```{r}
vdj_combined = readRDS(file = paste0(working.dir,"/analysis_jyu/vdj_8combined_1kfeature_noBatchRmv1.rds"))
```

## add clinical info

```{r}
sample_info = read.csv(file=paste0(working.dir,"/analysis_jyu/sample_info.txt"))
tmp_data = vdj_combined@meta.data
tmp_data$order = c(1:nrow(tmp_data))
tmp_data = merge(tmp_data[,c("sample","order")],sample_info,by.x="sample",by.y="sample")
tmp_data = tmp_data[order(tmp_data$order),]
rownames(tmp_data) = rownames(vdj_combined@meta.data)

vdj_combined = AddMetaData(vdj_combined,metadata = tmp_data[,"variant"],col.name = "variant")
vdj_combined = AddMetaData(vdj_combined,metadata = tmp_data[,"age"],col.name = "age")
vdj_combined = AddMetaData(vdj_combined,metadata = tmp_data[,"relationship"],col.name = "relationship")

rm(sample_info, tmp_data)
```
## rename cells
ClassicalMonocyte, Megakaryocyte

0:restingCD4+ (IL7R,AQP3) source: https://www.nature.com/articles/s41467-019-12464-3
1,5:NaiveCD4+(SELL,KLF2,TCF7): https://www.nature.com/articles/s41467-019-12464-3
11:Treg/Tfh (FXP3,CTLA4):https://www.nature.com/articles/s41467-019-12464-3
3:cytotoxicCD8+Tcell(FCGR3A,KLRF1): https://www.cell.com/action/showPdf?pii=S0092-8674%2818%2931568-X
4:naiveCD8+(CCR7,SELL,TCF7):https://www.nature.com/articles/s41467-019-12464-3
10,15: dysfunctionCD8(LAG3):https://www.cell.com/action/showPdf?pii=S0092-8674%2818%2931568-X
14:gamma-delta (TRDV2, TRGV9): https://www.nature.com/articles/s41590-020-0762-x

### cluster_celltype

```{r}
Idents(vdj_combined) = "seurat_clusters"

vdj_combined = RenameIdents(vdj_combined,
                            "0" = "0:RestingCD4+Tcell", 
                            "1" = "1:NaiveCD4+Tcell",
                            "2" = "2:CD8+Tcell",
                            "3" = "3:CytotoxicCD8+Tcell",
                            "4" = "4:NaiveCD8+Tcell",
                            "5" = "5:NaiveCD4+Tcell",
                            "6" = "6:NKcell",
                            "7" = "7:Bcell",
                            "8" = "8:CD8+Tcell",
                            "9" = "9:Monocyte",
                            "10" = "10:DysfunctionCD8+Tcell",
                            "11" = "11:Tregcell",
                            "12" = "12:Bcell",
                            "13" = "13:Doublets",
                            "14" = "14:GammaDeltaTcell",
                            "15" = "15:DysfunctionCD8+Tcell",
                            "16" = "16:Megakaryocyte",
                            "17" = "17:Bcell",
                            "18" = "18:NonClassicalMonocyte",
                            "19" = "19:NKcell",
                            "20" = "20:Plasmablasts",
                            "21" = "21:pDC",
                            "22" = "22:Plasmablasts"
                            )

vdj_combined$cluster_celltype = vdj_combined@active.ident
```

### cell type

```{r}
Idents(vdj_combined) = "seurat_clusters"

vdj_combined = RenameIdents(vdj_combined,
                            "0" = "CD4+Tcell",
                            "1" = "CD4+Tcell",
                            "2" = "CD8+Tcell",
                            "3" = "CD8+Tcell",
                            "4" = "CD8+Tcell",
                            "5" = "CD4+Tcell",
                            "6" = "NKcell",
                            "7" = "Bcell",
                            "8" = "CD8+Tcell",
                            "9" = "Monocyte",
                            "10" = "CD8+Tcell",
                            "11" = "CD4+Tcell",
                            "12" = "Bcell",
                            "13" = "CD8+Tcell",
                            "14" = "CD8+Tcell",
                            "15" = "CD8+Tcell",
                            "16" = "Megakaryocyte",
                            "17" = "Bcell",
                            "18" = "NonClassicalMonocyte",
                            "19" = "NKcell",
                            "20" = "Plasmablasts",
                            "21" = "pDC",
                            "22" = "Plasmablasts")

vdj_combined$celltype = vdj_combined@active.ident

Idents(vdj_combined) = "seurat_clusters"

vdj_combined = RenameIdents(vdj_combined,
                            "0" = "Tcell",
                            "1" = "Tcell",
                            "2" = "Tcell",
                            "3" = "Tcell",
                            "4" = "Tcell",
                            "5" = "Tcell",
                            "6" = "NKcell",
                            "7" = "Bcell",
                            "8" = "Tcell",
                            "9" = "Monocyte",
                            "10" = "Tcell",
                            "11" = "Tcell",
                            "12" = "Bcell",
                            "13" = "NKcell",
                            "14" = "Tcell",
                            "15" = "Tcell",
                            "16" = "Megakaryocyte",
                            "17" = "Bcell",
                            "18" = "Monocyte",
                            "19" = "NKcell",
                            "20" = "Plasmablasts",
                            "21" = "pDC",
                            "22" = "Plasmablasts")

vdj_combined$major = vdj_combined@active.ident
```

# select OAS2 patients only

```{r}
oas2 = subset(vdj_combined,subset=variant=="OAS2")
rm(vdj_combined)
gc()
```

## label texts

```{r}
cluster_anno = c("0" = "0:CD4+Tcell",
                            "1" = "1:CD4+Tcell",
                            "2" = "2:CD8+Tcell",
                            "3" = "3:CD8+Tcell",
                            "4" = "4:CD8+Tcell",
                            "5" = "5:CD4+Tcell",
                            "6" = "6:NKcell",
                            "7" = "7:Bcell",
                            "8" = "8:CD8+Tcell",
                            "9" = "9:Monocyte",
                            "10" = "10:CD8+Tcell",
                            "11" = "11:CD4+Tcell",
                            "12" = "12:Bcell",
                            "13" = "13:CD8+Tcell",
                            "14" = "14:CD8+Tcell",
                            "15" = "15:CD8+Tcell",
                            "16" = "16:Megakaryocyte",
                            "17" = "17:Bcell",
                            "18" = "18:NonClassicalMonocyte",
                            "19" = "19:NKcell",
                            "20" = "20:Plasmablasts",
                            "21" = "21:pDC",
                            "22" = "22:Plasmablasts")
```


# fig1:overall umap 

```{r}
p1 = DimPlot(oas2,group.by = "seurat_clusters",dims = c(1,3),label = TRUE)+
  labs(title = c(""))+
  geom_text(x=10,y=-5,label = "n = 10,671 cells")+
  # theme(legend.position = "NULL")+
  scale_color_discrete(name = "", labels = cluster_anno)+
  theme(axis.text = element_text(size = 10))

pdf(file = paste0(working.dir,"/AOS2_paper/fig1_overall_umap.pdf"),height = 6,width = 10)
p1
dev.off()
```


# figS1-2:quality vlnplot

```{r}
p2 = VlnPlot(oas2,features = c("nFeature_RNA"),group.by = "cluster_celltype",pt.size = 0)+
  coord_flip()+
  labs(title = c("Number of unqiue genes"))+
  xlab("")+
  # geom_text(x=10,y=-5,label = "n = 10,671 cells")+
  theme(legend.position = "NULL",
        plot.title = element_text(size = 10),
        axis.text.x = element_text(angle = 0, vjust = 0, hjust=0.5),
        axis.text = element_text(size = 10))
  # scale_color_discrete(name = "", labels = cluster_anno)

p3 = VlnPlot(oas2,features = c("percent.mt"),group.by = "cluster_celltype",pt.size = 0)+
  coord_flip()+
  labs(title = c("Frequency of mitochondria genes (%)"))+
  xlab("")+
  # geom_text(x=10,y=-5,label = "n = 10,671 cells")+
  theme(legend.position = "NULL",
        plot.title = element_text(size = 10),
        axis.text.x = element_text(angle = 0, vjust = 0, hjust=0.5),
        axis.text = element_text(size = 10))

pdf(file = paste0(working.dir,"/AOS2_paper/figs1_nFeature_RNA.pdf"),height = 6,width = 5)
p2
dev.off()


pdf(file = paste0(working.dir,"/AOS2_paper/figs2_percent_mt.pdf"),height = 6,width = 5)
p3
dev.off()
```


# fig2:

```{r}
p2 = DimPlot(subset(oas2,subset=age==17),dims = c(1,3),label = TRUE,group.by = "cluster_celltype")+
  labs(title = c("HD0011,17 yrs (7,787 cells)"))+
  theme(legend.position = "NULL",
        plot.title = element_text(size = 10))

p3 = DimPlot(subset(oas2,subset=age==23),dims = c(1,3),label = TRUE)+
  labs(title = c("HD0025,23 yrs (2,884 cells)"))+
  theme(plot.title = element_text(size = 10))

p1 + p2
```

